<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="My Classroom - FocusFlow">
    <title>My Classroom - FocusFlow</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <style>
        .stat-card {
            border: 1px solid var(--bg-tertiary);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }
    </style>
</head>

<body>
    <div class="layout-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <span>‚óÄ</span>
            </div>
            <div class="sidebar-header">
                <a href="#" class="sidebar-brand">FocusFlow</a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="student_dashboard.html" class="nav-link">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="study.html" class="nav-link">
                        <span>‚è±Ô∏è</span>
                        <span>Start Session</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="student_dashboard.html#classroomsList" class="nav-link active">
                        <span>üìö</span>
                        <span>All Classrooms</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="student_manage_classes.html" class="nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Classroom Management</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="games.html" class="nav-link">
                        <span>üéÆ</span>
                        <span>Game Room</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile mb-3">
                    <div class="avatar-circle" id="userAvatar">S</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Student</div>
                        <div class="user-role">Student</div>
                    </div>
                </div>
                <button class="btn btn-outline btn-sm w-100" onclick="logout()">Sign Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="container-fluid">
                <!-- Mobile Toggle -->
                <button class="btn btn-sm btn-secondary d-md-none mb-3" onclick="toggleSidebarMobile()">
                    ‚ò∞ Menu
                </button>
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <a href="student_dashboard.html" class="btn btn-outline btn-sm">‚Üê Back</a>
                        <div>
                            <h2 class="mb-0" id="className">Loading...</h2>
                            <p class="text-secondary small mb-0">Teacher: <span class="text-white"
                                    id="teacherName">...</span></p>
                        </div>
                    </div>
                </div>

                <!-- My Stats in this Classroom -->
                <h5 class="section-title mb-3">My Performance in this Class</h5>
                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-secondary text-uppercase mb-2" style="font-size: 0.75rem;">Total Sessions
                            </h6>
                            <h2 class="mb-0" id="mySessions">--</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-secondary text-uppercase mb-2" style="font-size: 0.75rem;">Avg Focus Score
                            </h6>
                            <h2 class="mb-0 text-primary" id="myAvgScore">--</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-secondary text-uppercase mb-2" style="font-size: 0.75rem;">Total Study Time
                            </h6>
                            <h2 class="mb-0 text-success" id="myStudyTime">--</h2>
                        </div>
                    </div>
                </div>

                <!-- My Session History -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">My Session History</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover text-white mb-0"
                                style="--bs-table-bg: transparent; --bs-table-color: var(--text-primary); --bs-table-hover-bg: var(--bg-hover);">
                                <thead style="border-bottom: 1px solid var(--bg-tertiary);">
                                    <tr>
                                        <th class="p-3">Date</th>
                                        <th class="p-3">Technique</th>
                                        <th class="p-3">Duration</th>
                                        <th class="p-3">Focus Score</th>
                                        <th class="p-3">State</th>
                                    </tr>
                                </thead>
                                <tbody id="sessionsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center p-4">Loading sessions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js?v=2"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const classroomId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await protectPage('student')) return;

            // Set user info
            const user = getUser();
            if (user) {
                document.getElementById('userName').innerText = user.username;
                document.getElementById('userAvatar').innerText = user.username.charAt(0).toUpperCase();
            }

            if (!classroomId) {
                window.location.href = 'student_dashboard.html';
                return;
            }
            loadClassroomData();
        });

        async function loadClassroomData() {
            try {
                // Get basic info (re-using list endpoint or new details endpoint? 
                // Student doesn't have access to /api/classrooms/{id} which is teacher only.
                // We need a student-specific endpoint or filter from the list.
                // Let's assume we fetch the list to get name/teacher, then fetch sessions.

                // 1. Get Class Info
                const listResp = await authenticatedFetch(`${API_URL}/api/classrooms/student/list`);
                const classrooms = await listResp.json();
                const cls = classrooms.find(c => c.id == classroomId);

                if (!cls) {
                    alert("Classroom not found.");
                    window.location.href = 'student_dashboard.html';
                    return;
                }

                document.getElementById('className').innerText = cls.name;
                document.getElementById('teacherName').innerText = cls.teacher_name;

                // 2. Get My Sessions in this Class
                // We need a new endpoint for this: GET /api/classrooms/{id}/my-sessions
                // Or we can client-side filter /api/sessions/history? But that might not include classroom_id in response model yet
                // Let's check `get_user_sessions` query in backend sessions_routes/db

                // Workaround: We will implement /api/classrooms/{id}/my-sessions
                const resp = await authenticatedFetch(`${API_URL}/api/classrooms/${classroomId}/my-sessions`);
                if (!resp.ok) throw new Error('Failed to load sessions');

                const sessions = await resp.json();
                renderStats(sessions);
                renderSessions(sessions);

            } catch (error) {
                console.error(error);
                document.getElementById('sessionsTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
            }
        }

        function renderStats(sessions) {
            const totalSessions = sessions.length;
            const totalTime = sessions.reduce((sum, s) => sum + s.duration, 0);
            const totalScore = sessions.reduce((sum, s) => sum + s.focus_score, 0);
            const avg = totalSessions ? Math.round(totalScore / totalSessions) : 0;

            document.getElementById('mySessions').innerText = totalSessions;
            document.getElementById('myAvgScore').innerText = avg;

            const hours = Math.floor(totalTime / 3600);
            const mins = Math.floor((totalTime % 3600) / 60);
            document.getElementById('myStudyTime').innerText = `${hours}h ${mins}m`;
        }

        function renderSessions(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            tbody.innerHTML = '';

            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary p-4">No sessions recorded in this classroom yet.</td></tr>';
                return;
            }

            sessions.forEach(session => {
                const date = new Date(session.timestamp).toLocaleString();
                const duration = Math.round(session.duration / 60) + ' min';
                const score = Math.round(session.focus_score);
                const scoreColor = score >= 80 ? 'text-success' : (score >= 50 ? 'text-warning' : 'text-danger');

                const row = `
                    <tr>
                        <td class="p-3">${date}</td>
                        <td class="p-3">${session.technique || 'None'}</td>
                        <td class="p-3">${duration}</td>
                        <td class="p-3 ${scoreColor} fw-bold">${score}</td>
                        <td class="p-3">${session.user_state}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Sidebar Toggle Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = sidebar.querySelector('.sidebar-toggle-btn span');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.innerText = "‚ñ∂";
            } else {
                toggleBtn.innerText = "‚óÄ";
            }
        }

        function toggleSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
    </script>
</body>

</html>